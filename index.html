<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PHS Walk Run Stopwatch</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Roboto+Mono:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .time-display {
            font-family: 'Roboto Mono', monospace;
        }
        .btn-disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        /* Custom scrollbar for better aesthetics */
        #laps-container::-webkit-scrollbar {
            width: 8px;
        }
        #laps-container::-webkit-scrollbar-track {
            background: #2d3748; /* bg-gray-800 */
        }
        #laps-container::-webkit-scrollbar-thumb {
            background: #4a5568; /* bg-gray-600 */
            border-radius: 4px;
        }
        #laps-container::-webkit-scrollbar-thumb:hover {
            background: #718096; /* bg-gray-500 */
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex flex-col items-center justify-center min-h-screen p-4">

    <!-- Hidden elements for camera functionality -->
    <video id="camera-stream" autoplay playsinline class="hidden w-0 h-0"></video>
    <canvas id="camera-canvas" class="hidden w-0 h-0"></canvas>

    <div class="w-full max-w-md bg-gray-800 rounded-2xl shadow-2xl p-6 md:p-8">
        <!-- Stopwatch Display -->
        <div class="text-center mb-8">
            <h1 class="text-4xl sm:text-5xl md:text-6xl font-bold time-display tracking-wider" id="stopwatch-display">
                00:00:00<span class="text-xl sm:text-2xl md:text-3xl text-gray-400">.00</span>
            </h1>
        </div>

        <!-- Control Buttons -->
        <div class="flex justify-center items-center space-x-4 mb-8">
            <button id="start-button" class="w-24 h-24 rounded-full bg-green-600 hover:bg-green-500 text-white text-xl font-semibold focus:outline-none focus:ring-4 focus:ring-green-400 transition-all duration-300 ease-in-out flex items-center justify-center shadow-lg">
                Start
            </button>
            <button id="lap-button" class="w-24 h-24 rounded-full bg-blue-600 hover:bg-blue-500 text-white text-xl font-semibold focus:outline-none focus:ring-4 focus:ring-blue-400 transition-all duration-300 ease-in-out flex items-center justify-center shadow-lg btn-disabled" disabled>
                Record
            </button>
            <button id="stop-button" class="w-24 h-24 rounded-full bg-red-600 hover:bg-red-500 text-white text-xl font-semibold focus:outline-none focus:ring-4 focus:ring-red-400 transition-all duration-300 ease-in-out flex items-center justify-center shadow-lg btn-disabled" disabled>
                Stop
            </button>
        </div>

        <!-- Laps Display -->
        <div id="laps-container" class="w-full max-h-64 overflow-y-auto pr-2">
            <ul id="laps-list" class="space-y-3">
                <!-- Recorded times and photos will be injected here by JavaScript -->
            </ul>
        </div>

        <!-- Download Buttons Container -->
        <div id="download-container" class="text-center mt-6 hidden flex flex-col sm:flex-row justify-center gap-4">
             <button id="download-photos-button" class="bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 px-6 rounded-lg focus:outline-none focus:ring-4 focus:ring-indigo-400 transition-all duration-300 ease-in-out shadow-lg">
                Download Photos
            </button>
            <button id="download-timings-button" class="bg-teal-600 hover:bg-teal-500 text-white font-bold py-3 px-6 rounded-lg focus:outline-none focus:ring-4 focus:ring-teal-400 transition-all duration-300 ease-in-out shadow-lg">
                Download Timings
            </button>
        </div>
    </div>

    <script>
        // DOM Elements
        const stopwatchDisplay = document.getElementById('stopwatch-display');
        const startButton = document.getElementById('start-button');
        const stopButton = document.getElementById('stop-button');
        const lapButton = document.getElementById('lap-button');
        const lapsList = document.getElementById('laps-list');
        const cameraStreamElement = document.getElementById('camera-stream');
        const cameraCanvasElement = document.getElementById('camera-canvas');
        const downloadContainer = document.getElementById('download-container');
        const downloadPhotosButton = document.getElementById('download-photos-button');
        const downloadTimingsButton = document.getElementById('download-timings-button');

        // State Variables
        let timer = null;
        let startTime = 0;
        let elapsedTime = 0;
        let isRunning = false;
        let lapCounter = 0;
        let recordedTimes = [];
        let cameraStream = null;
        let audioCtx = null; // For generating the beep sound

        // --- Event Listeners ---
        stopButton.addEventListener('click', stopStopwatch);
        downloadPhotosButton.addEventListener('click', downloadPhotosAsZip);
        downloadTimingsButton.addEventListener('click', downloadTimingsAsTxt);

        // --- Core Functions ---

        async function startStopwatch() {
            if (isRunning) return;

            // FIX: Immediately disable the start button to prevent double-clicks
            // while waiting for camera permission.
            startButton.disabled = true;
            startButton.classList.add('btn-disabled');

            if (!cameraStream) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                    cameraStreamElement.srcObject = stream;
                    cameraStream = stream;
                } catch (err) {
                    console.error("Error accessing camera:", err);
                }
            }

            startTime = Date.now() - elapsedTime;
            timer = setInterval(updateDisplay, 10);
            isRunning = true;
            updateButtonStates();
        }

        function stopStopwatch() {
            if (isRunning) {
                clearInterval(timer);
                elapsedTime = Date.now() - startTime;
                isRunning = false;
                stopCameraStream();
                updateButtonStates();
            }
        }
        
        function resetStopwatch() {
            clearInterval(timer);
            stopCameraStream();
            isRunning = false;
            elapsedTime = 0;
            startTime = 0;
            lapCounter = 0;
            recordedTimes = [];
            stopwatchDisplay.innerHTML = '00:00:00<span class="text-xl sm:text-2xl md:text-3xl text-gray-400">.00</span>';
            lapsList.innerHTML = '';
            updateButtonStates();
        }

        function recordTime() {
            if (isRunning) {
                playBeep(); // Play the beep sound
                // Immediately disable the button to prevent double-clicks.
                lapButton.disabled = true;
                lapButton.classList.add('btn-disabled');
                
                lapCounter++;
                const totalTime = Date.now() - startTime;
                const photoDataUrl = capturePhoto();

                recordedTimes.push({ time: totalTime, image: photoDataUrl });

                const lapElement = document.createElement('li');
                lapElement.className = 'flex items-center bg-gray-700 p-3 rounded-lg text-lg space-x-4';
                
                if (photoDataUrl) {
                    const imgElement = document.createElement('img');
                    imgElement.src = photoDataUrl;
                    imgElement.className = 'w-16 h-16 rounded-md object-cover flex-shrink-0';
                    lapElement.appendChild(imgElement);
                }

                const textContainer = document.createElement('div');
                textContainer.className = 'flex-grow flex justify-between items-center';

                const lapNumberSpan = document.createElement('span');
                lapNumberSpan.className = 'font-semibold text-gray-300';
                lapNumberSpan.textContent = `Time ${lapCounter}`;
                
                const lapTimeSpan = document.createElement('span');
                lapTimeSpan.className = 'font-medium time-display';
                lapTimeSpan.textContent = formatTime(totalTime);

                textContainer.appendChild(lapNumberSpan);
                textContainer.appendChild(lapTimeSpan);
                lapElement.appendChild(textContainer);

                lapsList.prepend(lapElement);

                // Re-enable the button after a short delay to prevent accidental double taps
                setTimeout(() => {
                    if (isRunning) { // Check if still running before re-enabling
                        lapButton.disabled = false;
                        lapButton.classList.remove('btn-disabled');
                    }
                }, 400);
            }
        }
        
        // --- Helper Functions ---

        function playBeep() {
            // Initialize AudioContext on the first user interaction to comply with browser policies
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
            
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(880, audioCtx.currentTime); // A nice, clear pitch (A5)
            gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime); // Not too loud

            oscillator.start(audioCtx.currentTime);
            // Stop the sound after a very short duration
            oscillator.stop(audioCtx.currentTime + 0.1); 
        }

        function capturePhoto() {
            if (!cameraStream || !cameraStream.active) {
                console.warn("Camera stream is not active. Cannot capture photo.");
                return null;
            }
            const context = cameraCanvasElement.getContext('2d');
            cameraCanvasElement.width = cameraStreamElement.videoWidth;
            cameraCanvasElement.height = cameraStreamElement.videoHeight;
            context.drawImage(cameraStreamElement, 0, 0, cameraCanvasElement.width, cameraCanvasElement.height);
            return cameraCanvasElement.toDataURL('image/jpeg', 0.8);
        }

        function stopCameraStream() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
                cameraStreamElement.srcObject = null;
            }
        }

        function updateDisplay() {
            const currentTime = Date.now();
            elapsedTime = currentTime - startTime;
            stopwatchDisplay.innerHTML = formatTime(elapsedTime, true);
        }
        
        function formatTime(timeInMillis, showMilliseconds = false) {
            let totalMilliseconds = timeInMillis;
            let hours = Math.floor(totalMilliseconds / 3600000);
            totalMilliseconds %= 3600000;
            let minutes = Math.floor(totalMilliseconds / 60000);
            totalMilliseconds %= 60000;
            let seconds = Math.floor(totalMilliseconds / 1000);
            let milliseconds = Math.floor((totalMilliseconds % 1000) / 10);

            const pad = (num) => num.toString().padStart(2, '0');

            if (showMilliseconds) {
                return `${pad(hours)}:${pad(minutes)}:${pad(seconds)}<span class="text-xl sm:text-2xl md:text-3xl text-gray-400">.${pad(milliseconds)}</span>`;
            }
            return `${pad(hours)}:${pad(minutes)}:${pad(seconds)}.${pad(milliseconds)}`;
        }

        async function downloadPhotosAsZip() {
            const photosToZip = recordedTimes.filter(r => r.image);
            if (photosToZip.length === 0) {
                downloadPhotosButton.textContent = 'No Photos!';
                setTimeout(() => { downloadPhotosButton.textContent = 'Download Photos'; }, 2000);
                return;
            }

            downloadPhotosButton.textContent = 'Zipping...';
            downloadPhotosButton.disabled = true;
            
            try {
                const zip = new JSZip();
                photosToZip.forEach((record, index) => {
                    // Use a consistent numbering based on overall recorded times
                    const recordIndex = recordedTimes.findIndex(r => r === record);
                    const base64Data = record.image.split(',')[1];
                    zip.file(`Time_${recordIndex + 1}.jpg`, base64Data, { base64: true });
                });

                const content = await zip.generateAsync({ type: "blob" });
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(content);
                link.download = "stopwatch_photos.zip";
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                downloadPhotosButton.textContent = 'Downloaded!';
            } catch (err) {
                console.error("Error creating zip file:", err);
                downloadPhotosButton.textContent = 'Error!';
            } finally {
                setTimeout(() => {
                    downloadPhotosButton.textContent = 'Download Photos';
                    downloadPhotosButton.disabled = false;
                }, 2000);
            }
        }
        
        function downloadTimingsAsTxt() {
            if (recordedTimes.length === 0) return;

            const textToSave = recordedTimes.map((record, index) => {
                return `Time ${index + 1}: ${formatTime(record.time)}`;
            }).join('\n');

            const blob = new Blob([textToSave], { type: 'text/plain;charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'stopwatch_timings.txt';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function copyTimingsToClipboard() {
            if (recordedTimes.length === 0) return;

            const textToCopy = recordedTimes.map((record, index) => {
                return `Time ${index + 1}: ${formatTime(record.time)}`;
            }).join('\n');

            const textArea = document.createElement('textarea');
            textArea.value = textToCopy;
            textArea.style.position = 'absolute';
            textArea.style.left = '-9999px';
            document.body.appendChild(textArea);
            
            textArea.select();
            textArea.setSelectionRange(0, 99999);

            try {
                document.execCommand('copy');
                lapButton.textContent = 'Copied!';
                setTimeout(() => { lapButton.textContent = 'Copy'; }, 2000);
            } catch (err) {
                console.error('Failed to copy timings: ', err);
                lapButton.textContent = 'Error!';
                 setTimeout(() => { lapButton.textContent = 'Copy'; }, 2000);
            }

            document.body.removeChild(textArea);
        }

        function updateButtonStates() {
            if (isRunning) {
                startButton.disabled = true;
                startButton.classList.add('btn-disabled');
                
                stopButton.disabled = false;
                stopButton.classList.remove('btn-disabled');
                
                lapButton.disabled = false;
                lapButton.classList.remove('btn-disabled');
                lapButton.classList.add('scale-110', 'transform'); // Make button bigger
                lapButton.textContent = "Record";
                lapButton.onclick = recordTime;
                lapButton.classList.replace('bg-purple-600', 'bg-blue-600');
                lapButton.classList.replace('hover:bg-purple-500', 'hover:bg-blue-500');
            } else {
                startButton.disabled = false;
                startButton.classList.remove('btn-disabled');
                lapButton.classList.remove('scale-110', 'transform'); // Return to normal size

                if (elapsedTime > 0) {
                   startButton.textContent = "Reset";
                   startButton.onclick = resetStopwatch;
                 } else {
                    startButton.textContent = "Start";
                    startButton.onclick = () => startStopwatch();
                 }
                
                stopButton.disabled = true;
                stopButton.classList.add('btn-disabled');

                if (recordedTimes.length > 0) {
                    lapButton.disabled = false;
                    lapButton.classList.remove('btn-disabled');
                    lapButton.textContent = "Copy";
                    lapButton.onclick = copyTimingsToClipboard;
                    lapButton.classList.replace('bg-blue-600', 'bg-purple-600');
                    lapButton.classList.replace('hover:bg-blue-500', 'hover:bg-purple-500');
                } else {
                    lapButton.disabled = true;
                    lapButton.classList.add('btn-disabled');
                    lapButton.textContent = "Record";
                    lapButton.onclick = recordTime;
                }
            }

            // Show/hide download buttons
            if (!isRunning && recordedTimes.length > 0) {
                downloadContainer.classList.remove('hidden');
                const hasPhotos = recordedTimes.some(r => r.image);
                downloadPhotosButton.disabled = !hasPhotos;
                if (hasPhotos) {
                    downloadPhotosButton.classList.remove('btn-disabled');
                } else {
                    downloadPhotosButton.classList.add('btn-disabled');
                }
            } else {
                downloadContainer.classList.add('hidden');
            }
        }
        
        // Set initial button state on page load
        updateButtonStates();
    </script>
</body>
</html>

